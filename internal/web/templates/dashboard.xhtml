{{define "title"}}Dashboard{{end}}
{{define "head"}}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
{{end}}
{{define "content"}}
<h1>Dashboard</h1>
<div class="refresh-indicator">Auto-refresh in <span id="countdown">30</span>s</div>

<div class="stats-grid">
  <div class="stat-card">
    <div class="stat-label">Throughput</div>
    <div class="stat-value">{{.BPS}}</div>
    <div class="stat-sub">{{.PPS}}</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Total Bytes</div>
    <div class="stat-value">{{formatBytes .TotalBytes}}</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Total Packets</div>
    <div class="stat-value">{{formatPkts .TotalPackets}}</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Flows ({{.Window}})</div>
    <div class="stat-value">{{.FlowCount}}</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Active Flows (last 60s)</div>
    <div class="stat-value">{{.ActiveFlows}}</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Active Hosts</div>
    <div class="stat-value"><a href="/hosts">{{.ActiveHosts}}</a></div>
  </div>
</div>

{{if or .Latency.FlowsWithRTT .Latency.FlowsWithThru}}
<div class="two-col">
  {{if .Latency.FlowsWithThru}}
  <div class="panel">
    <h2>Throughput Percentiles</h2>
    <table>
      <thead>
        <tr><th>Metric</th><th>Value</th></tr>
      </thead>
      <tbody>
        <tr><td>Average</td><td>{{.Latency.AvgThru}}</td></tr>
        <tr><td>p50 (Median)</td><td>{{.Latency.P50Thru}}</td></tr>
        <tr><td>p95</td><td>{{.Latency.P95Thru}}</td></tr>
        <tr><td>p99</td><td>{{.Latency.P99Thru}}</td></tr>
      </tbody>
    </table>
    <p class="flow-summary">Based on {{.Latency.FlowsWithThru}} flows with duration &gt; 0</p>
  </div>
  {{end}}

  {{if .Latency.FlowsWithRTT}}
  <div class="panel">
    <h2>RTT Latency Percentiles</h2>
    <table>
      <thead>
        <tr><th>Metric</th><th>Value</th></tr>
      </thead>
      <tbody>
        <tr><td>Average</td><td>{{.Latency.AvgRTT}}</td></tr>
        <tr><td>p50 (Median)</td><td>{{.Latency.P50RTT}}</td></tr>
        <tr><td>p95</td><td>{{.Latency.P95RTT}}</td></tr>
        <tr><td>p99</td><td>{{.Latency.P99RTT}}</td></tr>
      </tbody>
    </table>
    <p class="flow-summary">Based on {{.Latency.FlowsWithRTT}} stitched bidirectional flows</p>
  </div>
  {{end}}
</div>
{{end}}

{{if .TCPHealth.TotalTCPFlows}}
<div class="two-col">
  <div class="panel">
    <h2>TCP Health Summary</h2>
    <table>
      <thead>
        <tr><th>Metric</th><th>Count</th><th>Rate</th></tr>
      </thead>
      <tbody>
        <tr>
          <td>TCP Flows</td>
          <td>{{.TCPHealth.TotalTCPFlows}}</td>
          <td>—</td>
        </tr>
        <tr>
          <td>Retransmissions</td>
          <td>{{.TCPHealth.TotalRetrans}} ({{.TCPHealth.FlowsWithRetrans}} flows)</td>
          <td>{{printf "%.2f" .TCPHealth.RetransRate}}%</td>
        </tr>
        <tr>
          <td>Out of Order</td>
          <td>{{.TCPHealth.TotalOOO}} ({{.TCPHealth.FlowsWithOOO}} flows)</td>
          <td>{{printf "%.2f" .TCPHealth.OOORate}}%</td>
        </tr>
        <tr>
          <td>Packet Loss</td>
          <td>{{.TCPHealth.TotalLoss}} ({{.TCPHealth.FlowsWithLoss}} flows)</td>
          <td>{{printf "%.2f" .TCPHealth.LossRate}}%</td>
        </tr>
      </tbody>
    </table>
    <p class="flow-summary">Based on {{.TCPHealth.TotalTCPPackets}} TCP packets</p>
  </div>

  <div class="panel">
    <h2>Top Affected TCP Flows</h2>
    {{if .TCPHealth.TopRetransFlows}}
    <table>
      <thead>
        <tr><th>Flow</th><th>Retrans</th><th>OOO</th><th>Loss</th><th>Rate</th></tr>
      </thead>
      <tbody>
        {{range .TCPHealth.TopRetransFlows}}
        <tr>
          <td>{{.SrcAddr}}:{{.SrcPort}} → {{.DstAddr}}:{{.DstPort}}</td>
          <td>{{.Retrans}}</td>
          <td>{{.OOO}}</td>
          <td>{{.Loss}}</td>
          <td>{{printf "%.2f" .RetransRate}}%</td>
        </tr>
        {{end}}
      </tbody>
    </table>
    {{else}}
    <p class="empty">No TCP quality issues detected.</p>
    {{end}}
  </div>
</div>
{{end}}

{{if .VoIP.TotalVoIPFlows}}
<div class="two-col">
  <div class="panel">
    <h2>VoIP Quality Summary</h2>
    <table>
      <thead>
        <tr><th>Metric</th><th>Value</th></tr>
      </thead>
      <tbody>
        <tr><td>VoIP/RTP Flows</td><td>{{.VoIP.TotalVoIPFlows}}</td></tr>
        {{if .VoIP.FlowsWithJitter}}
        <tr><td>Avg Jitter</td><td>{{.VoIP.AvgJitter}}</td></tr>
        <tr><td>p50 Jitter</td><td>{{.VoIP.P50Jitter}}</td></tr>
        <tr><td>p95 Jitter</td><td>{{.VoIP.P95Jitter}}</td></tr>
        {{end}}
        {{if .VoIP.FlowsWithMOS}}
        <tr><td>Avg MOS</td><td>{{.VoIP.AvgMOS}}</td></tr>
        <tr><td>Min MOS</td><td>{{.VoIP.MinMOS}}</td></tr>
        <tr><td>Flows Below MOS 3.5</td><td>{{.VoIP.FlowsBelowMOS35}}</td></tr>
        {{end}}
      </tbody>
    </table>
    <p class="flow-summary">Based on {{.VoIP.TotalVoIPFlows}} detected VoIP flows (UDP 10000–20000, SIP 5060/5061)</p>
  </div>

  <div class="panel">
    <h2>Top VoIP Flows</h2>
    {{if .VoIP.TopVoIPFlows}}
    <table>
      <thead>
        <tr><th>Flow</th><th>Jitter</th><th>MOS</th><th>Loss</th><th>Packets</th></tr>
      </thead>
      <tbody>
        {{range .VoIP.TopVoIPFlows}}
        <tr>
          <td>{{.SrcAddr}}:{{.SrcPort}} → {{.DstAddr}}:{{.DstPort}}</td>
          <td>{{.Jitter}}</td>
          <td><span class="mos-{{.MOSClass}}">{{.MOS}}</span></td>
          <td>{{.Loss}}</td>
          <td>{{.Packets}}</td>
        </tr>
        {{end}}
      </tbody>
    </table>
    {{else}}
    <p class="empty">No VoIP flows detected.</p>
    {{end}}
  </div>
</div>
{{end}}

<div class="two-col">
  <div class="panel">
    <h2>Top Sources</h2>
    {{if .TopSrc}}
    <table>
      <thead>
        <tr><th>Source IP</th><th>Bytes</th><th>Packets</th><th>%</th></tr>
      </thead>
      <tbody>
        {{range .TopSrc}}
        <tr>
          <td><a href="/flows?src_ip={{.IP}}">{{.IP}}</a></td>
          <td>{{formatBytes .Bytes}}</td>
          <td>{{formatPkts .Packets}}</td>
          <td>
            <div class="bar-bg"><div class="bar-fill" style="width:{{.Pct}}%"></div></div>
            {{.Pct}}%
          </td>
        </tr>
        {{end}}
      </tbody>
    </table>
    {{else}}
    <p class="empty">No flow data yet.</p>
    {{end}}
  </div>

  <div class="panel">
    <h2>Top Destinations</h2>
    {{if .TopDst}}
    <table>
      <thead>
        <tr><th>Destination IP</th><th>Bytes</th><th>Packets</th><th>%</th></tr>
      </thead>
      <tbody>
        {{range .TopDst}}
        <tr>
          <td><a href="/flows?dst_ip={{.IP}}">{{.IP}}</a></td>
          <td>{{formatBytes .Bytes}}</td>
          <td>{{formatPkts .Packets}}</td>
          <td>
            <div class="bar-bg"><div class="bar-fill" style="width:{{.Pct}}%"></div></div>
            {{.Pct}}%
          </td>
        </tr>
        {{end}}
      </tbody>
    </table>
    {{else}}
    <p class="empty">No flow data yet.</p>
    {{end}}
  </div>
</div>

<div class="two-col">
  <div class="panel">
    <h2>L7 Application Protocols</h2>
    {{if .AppProtocols}}
    <table>
      <thead>
        <tr><th>Application</th><th>Bytes</th><th>Flows</th><th>Share</th></tr>
      </thead>
      <tbody>
        {{range .AppProtocols}}
        <tr>
          <td>{{.Name}}</td>
          <td>{{formatBytes .Bytes}}</td>
          <td>{{.Flows}}</td>
          <td>
            <div class="bar-bg"><div class="bar-fill app" style="width:{{.Pct}}%"></div></div>
            {{.Pct}}%
          </td>
        </tr>
        {{end}}
      </tbody>
    </table>
    {{else}}
    <p class="empty">No flow data yet.</p>
    {{end}}
  </div>

  <div class="panel">
    <h2>Traffic Categories</h2>
    {{if .Categories}}
    <table>
      <thead>
        <tr><th>Category</th><th>Bytes</th><th>Flows</th><th>Share</th></tr>
      </thead>
      <tbody>
        {{range .Categories}}
        <tr>
          <td>{{.Name}}</td>
          <td>{{formatBytes .Bytes}}</td>
          <td>{{.Flows}}</td>
          <td>
            <div class="bar-bg"><div class="bar-fill cat" style="width:{{.Pct}}%"></div></div>
            {{.Pct}}%
          </td>
        </tr>
        {{end}}
      </tbody>
    </table>
    {{else}}
    <p class="empty">No flow data yet.</p>
    {{end}}
  </div>
</div>

{{if .Interfaces}}
<div class="panel">
  <h2>Traffic by Interface{{if .IfaceFilter}} <span class="filter-badge">Filtered: if{{.IfaceFilter}}</span>{{end}}</h2>
  <table>
    <thead>
      <tr><th>Interface</th><th>Index</th><th>Bytes</th><th>Packets</th><th>Flows</th><th>Share</th><th>Filter</th></tr>
    </thead>
    <tbody>
      {{range .Interfaces}}
      <tr>
        <td>{{.Name}}</td>
        <td>{{.Index}}</td>
        <td>{{formatBytes .Bytes}}</td>
        <td>{{formatPkts .Packets}}</td>
        <td>{{.Flows}}</td>
        <td>
          <div class="bar-bg"><div class="bar-fill iface" style="width:{{.Pct}}%"></div></div>
          {{.Pct}}%
        </td>
        <td><a href="/?iface={{.Index}}">view</a></td>
      </tr>
      {{end}}
    </tbody>
  </table>
  {{if .IfaceFilter}}<p><a href="/">Clear interface filter</a></p>{{end}}
</div>
{{end}}

<div class="two-col">
  <div class="panel">
    <h2>Protocol Breakdown</h2>
    {{if .Protocols}}
    <table>
      <thead>
        <tr><th>Protocol</th><th>Bytes</th><th>Packets</th><th>Share</th></tr>
      </thead>
      <tbody>
        {{range .Protocols}}
        <tr>
          <td>{{.Name}}</td>
          <td>{{formatBytes .Bytes}}</td>
          <td>{{formatPkts .Packets}}</td>
          <td>
            <div class="bar-bg"><div class="bar-fill proto" style="width:{{.Pct}}%"></div></div>
            {{.Pct}}%
          </td>
        </tr>
        {{end}}
      </tbody>
    </table>
    {{else}}
    <p class="empty">No flow data yet.</p>
    {{end}}
  </div>

  <div class="panel">
    <h2>Top Autonomous Systems</h2>
    {{if .TopAS}}
    <table>
      <thead>
        <tr><th>AS</th><th>Organisation</th><th>Bytes</th><th>Share</th></tr>
      </thead>
      <tbody>
        {{range .TopAS}}
        <tr>
          <td>{{if .ASN}}AS{{.ASN}}{{else}}—{{end}}</td>
          <td>{{.Name}}</td>
          <td>{{formatBytes .Bytes}}</td>
          <td>
            <div class="bar-bg"><div class="bar-fill as" style="width:{{.Pct}}%"></div></div>
            {{.Pct}}%
          </td>
        </tr>
        {{end}}
      </tbody>
    </table>
    {{else}}
    <p class="empty">No flow data yet.</p>
    {{end}}
  </div>
</div>

{{if .ChartProtoLabels}}
<div class="two-col">
  <div class="panel">
    <h2>Protocol Distribution</h2>
    <div class="chart-container"><canvas id="protoChart"></canvas></div>
  </div>
  <div class="panel">
    <h2>Top Talkers</h2>
    <div class="chart-container"><canvas id="talkersChart"></canvas></div>
  </div>
</div>
{{end}}

{{if .ChartTimeLabels}}
<div class="panel">
  <h2>Throughput Over Time</h2>
  <div class="chart-container chart-container-sm"><canvas id="thruChart"></canvas></div>
</div>
{{end}}

<script>
(function(){
  // Auto-refresh with countdown (preserves scroll position)
  var secs=30,el=document.getElementById('countdown');
  if(el){
    setInterval(function(){
      secs--;
      if(el)el.textContent=secs;
      if(secs<=0){
        try{sessionStorage.setItem('flowlens-scroll',window.scrollY)}catch(e){}
        location.reload();
      }
    },1000);
  }
  try{
    var sy=sessionStorage.getItem('flowlens-scroll');
    if(sy){window.scrollTo(0,parseInt(sy,10));sessionStorage.removeItem('flowlens-scroll')}
  }catch(e){}

  // Charts (only if Chart.js loaded)
  if(typeof Chart==='undefined')return;
  var darkMode=false;
  try{darkMode=localStorage.getItem('flowlens-dark')==='1'}catch(e){}
  var gridColor=darkMode?'rgba(139,148,158,0.2)':'rgba(0,0,0,0.1)';
  var textColor=darkMode?'#8b949e':'#586069';
  Chart.defaults.color=textColor;
  Chart.defaults.borderColor=gridColor;

  {{if .ChartProtoLabels}}
  new Chart(document.getElementById('protoChart'),{
    type:'doughnut',
    data:{labels:[{{range $i,$l := .ChartProtoLabels}}{{if $i}},{{end}}"{{$l}}"{{end}}],
    datasets:[{data:[{{range $i,$v := .ChartProtoValues}}{{if $i}},{{end}}{{$v}}{{end}}],
    backgroundColor:['#0366d6','#28a745','#e36209','#6f42c1','#d73a49','#dbab09','#24292e','#586069']}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right'}}}
  });
  new Chart(document.getElementById('talkersChart'),{
    type:'bar',
    data:{labels:[{{range $i,$l := .ChartTalkerLabels}}{{if $i}},{{end}}"{{$l}}"{{end}}],
    datasets:[{label:'Bytes',data:[{{range $i,$v := .ChartTalkerValues}}{{if $i}},{{end}}{{$v}}{{end}}],
    backgroundColor:'#0366d6'}]},
    options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,
    plugins:{legend:{display:false}},
    scales:{x:{ticks:{callback:function(v){
      if(v>=1e9)return(v/1e9).toFixed(1)+'G';
      if(v>=1e6)return(v/1e6).toFixed(1)+'M';
      if(v>=1e3)return(v/1e3).toFixed(1)+'K';
      return v;
    }}}}}
  });
  {{end}}

  {{if .ChartTimeLabels}}
  new Chart(document.getElementById('thruChart'),{
    type:'line',
    data:{labels:[{{range $i,$l := .ChartTimeLabels}}{{if $i}},{{end}}"{{$l}}"{{end}}],
    datasets:[{label:'Bytes',data:[{{range $i,$v := .ChartTimeValues}}{{if $i}},{{end}}{{$v}}{{end}}],
    borderColor:'#0366d6',backgroundColor:'rgba(3,102,214,0.1)',fill:true,tension:0.3,pointRadius:1}]},
    options:{responsive:true,maintainAspectRatio:false,
    plugins:{legend:{display:false}},
    scales:{y:{ticks:{callback:function(v){
      if(v>=1e9)return(v/1e9).toFixed(1)+'G';
      if(v>=1e6)return(v/1e6).toFixed(1)+'M';
      if(v>=1e3)return(v/1e3).toFixed(1)+'K';
      return v;
    }}}}}
  });
  {{end}}
})();
</script>
{{end}}
